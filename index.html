<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoMaster - تطبيق الصور الذكي</title>
    
    <!-- Bootstrap & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Animation Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <!-- Lightbox for gallery -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* متغيرات الألوان */
        :root {
            --primary: #4158D0;
            --secondary: #C850C0;
            --accent: #FFCC70;
            --dark: #1a1a2e;
            --light: #f0f0f0;
            --success: #00b09b;
            --warning: #f9d423;
            --danger: #ff6b6b;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* شاشة البداية المتحركة */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .splash-content {
            text-align: center;
            color: white;
        }

        .splash-logo {
            font-size: 120px;
            margin-bottom: 30px;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
        }

        .splash-title {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 2px;
        }

        .splash-subtitle {
            font-size: 20px;
            opacity: 0.9;
            margin-bottom: 40px;
        }

        .loading-bar {
            width: 300px;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            margin: 20px auto;
            overflow: hidden;
        }

        .loading-progress {
            width: 0%;
            height: 100%;
            background: white;
            border-radius: 10px;
            animation: loading 2s ease-in-out forwards;
        }

        /* شريط التنقل المتطور */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.3);
        }

        .navbar-brand {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 50px;
            font-size: 14px;
            transition: 0.3s;
        }

        .search-box input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(65, 88, 208, 0.2);
        }

        .search-box i {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        /* بطاقة المستخدم المتطورة */
        .user-profile-card {
            background: white;
            border-radius: 60px;
            padding: 8px 15px 8px 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: 0.3s;
        }

        .user-profile-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 700;
            color: #333;
            font-size: 14px;
        }

        .user-stats {
            font-size: 12px;
            color: #666;
        }

        /* منطقة الإحصائيات */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: 0.3s;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
        }

        .stat-info h4 {
            font-size: 24px;
            font-weight: 800;
            margin: 0;
            color: #333;
        }

        .stat-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        /* منطقة رفع الصور المتطورة */
        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 40px;
            margin: 30px 0;
            border: 3px dashed transparent;
            transition: 0.3s;
            cursor: pointer;
            text-align: center;
        }

        .upload-section.dragover {
            border-color: var(--primary);
            background: rgba(65, 88, 208, 0.05);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 80px;
            color: var(--primary);
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        .upload-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #666;
            margin-bottom: 20px;
        }

        .upload-formats {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .format-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 12px;
        }

        /* عرض الصور المتطور */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .photo-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: 0.3s;
            position: relative;
            cursor: pointer;
            animation: fadeInUp 0.5s ease;
        }

        .photo-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .photo-card:hover .photo-overlay {
            opacity: 1;
        }

        .photo-img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            transition: 0.5s;
        }

        .photo-card:hover .photo-img {
            transform: scale(1.1);
        }

        .photo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.8));
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 15px;
            opacity: 0;
            transition: 0.3s;
        }

        .photo-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .photo-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            transition: 0.3s;
            cursor: pointer;
        }

        .photo-action-btn:hover {
            transform: scale(1.1);
        }

        .photo-action-btn.delete:hover {
            background: var(--danger);
            color: white;
        }

        .photo-action-btn.download:hover {
            background: var(--success);
            color: white;
        }

        .photo-info {
            color: white;
        }

        .photo-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .photo-date {
            font-size: 12px;
            opacity: 0.8;
        }

        /* التصنيفات */
        .categories-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .category-chip {
            padding: 8px 20px;
            border-radius: 50px;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            transition: 0.3s;
            border: 1px solid rgba(255,255,255,0.3);
            font-size: 14px;
        }

        .category-chip.active {
            background: white;
            color: var(--primary);
            font-weight: 600;
        }

        .category-chip:hover {
            background: white;
            color: var(--primary);
        }

        /* نافذة منبثقة متطورة */
        .modal-modern .modal-content {
            border-radius: 30px;
            overflow: hidden;
            border: none;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }

        .modal-modern .modal-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 20px 30px;
        }

        .modal-modern .modal-body {
            padding: 30px;
        }

        .modal-modern .modal-footer {
            border: none;
            padding: 20px 30px;
        }

        .preview-image {
            width: 100%;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* رسائل التنبيه */
        .notification-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
        }

        .notification {
            background: white;
            border-radius: 10px;
            padding: 15px 25px;
            margin-bottom: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideInLeft 0.3s ease;
            border-right: 4px solid;
        }

        .notification.success {
            border-right-color: var(--success);
        }

        .notification.error {
            border-right-color: var(--danger);
        }

        .notification.info {
            border-right-color: var(--primary);
        }

        .notification-icon {
            font-size: 24px;
        }

        .notification.success .notification-icon {
            color: var(--success);
        }

        .notification.error .notification-icon {
            color: var(--danger);
        }

        .notification.info .notification-icon {
            color: var(--primary);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 700;
            margin-bottom: 5px;
        }

        .notification-message {
            font-size: 14px;
            color: #666;
        }

        /* شاشة فارغة متطورة */
        .empty-state-modern {
            text-align: center;
            padding: 80px 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 30px;
            backdrop-filter: blur(10px);
            margin: 30px 0;
        }

        .empty-icon {
            font-size: 120px;
            color: white;
            margin-bottom: 30px;
            opacity: 0.8;
            animation: float 3s ease-in-out infinite;
        }

        .empty-title {
            font-size: 32px;
            font-weight: 700;
            color: white;
            margin-bottom: 15px;
        }

        .empty-description {
            color: rgba(255,255,255,0.8);
            margin-bottom: 30px;
            font-size: 18px;
        }

        .btn-modern {
            background: white;
            color: var(--primary);
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 16px;
            transition: 0.3s;
            cursor: pointer;
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* الرسوم المتحركة */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes loading {
            from { width: 0%; }
            to { width: 100%; }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* الوضع الليلي */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            }
        }

        /* التجاوب مع الأجهزة */
        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 22px;
            }
            
            .search-box {
                width: 200px;
            }
            
            .grid-container {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .splash-title {
                font-size: 32px;
            }
            
            .splash-logo {
                font-size: 80px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- شاشة البداية -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-content animate__animated animate__fadeIn">
            <i class="fas fa-camera-retro splash-logo"></i>
            <h1 class="splash-title">PhotoMaster</h1>
            <p class="splash-subtitle">تطبيق الصور الذكي والمتطور</p>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
        </div>
    </div>

    <!-- التطبيق الرئيسي -->
    <div id="mainApp" style="display: none;">
        <!-- شريط التنقل المتطور -->
        <nav class="navbar navbar-expand-lg fixed-top">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-camera me-2"></i>
                    PhotoMaster
                </a>

                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ابحث عن صور..." onkeyup="searchPhotos()">
                    <i class="fas fa-search"></i>
                </div>

                <div class="user-profile-card" onclick="toggleUserMenu()">
                    <div class="user-info">
                        <div class="user-name" id="displayName">زائر</div>
                        <div class="user-stats" id="displayStats">0 صورة</div>
                    </div>
                    <div class="user-avatar" id="userAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            </div>
        </nav>

        <!-- قائمة المستخدم المنسدلة -->
        <div id="userMenu" class="user-menu" style="display: none;">
            <!-- سيتم إضافتها عبر JavaScript -->
        </div>

        <!-- المحتوى الرئيسي -->
        <div class="container" style="margin-top: 120px;">
            <!-- إحصائيات متطورة -->
            <div class="stats-grid">
                <div class="stat-card" onclick="filterByType('all')">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #4158D0, #C850C0);">
                        <i class="fas fa-images"></i>
                    </div>
                    <div class="stat-info">
                        <h4 id="totalPhotos">0</h4>
                        <p>إجمالي الصور</p>
                    </div>
                </div>

                <div class="stat-card" onclick="filterByType('today')">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #00b09b, #96c93d);">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="stat-info">
                        <h4 id="todayPhotos">0</h4>
                        <p>اليوم</p>
                    </div>
                </div>

                <div class="stat-card" onclick="filterByType('week')">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f9d423, #f83600);">
                        <i class="fas fa-calendar-week"></i>
                    </div>
                    <div class="stat-info">
                        <h4 id="weekPhotos">0</h4>
                        <p>هذا الأسبوع</p>
                    </div>
                </div>

                <div class="stat-card" onclick="filterByType('month')">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h4 id="monthPhotos">0</h4>
                        <p>هذا الشهر</p>
                    </div>
                </div>
            </div>

            <!-- أزرار التصنيف -->
            <div class="categories-bar">
                <span class="category-chip active" onclick="filterCategory('all')">الكل</span>
                <span class="category-chip" onclick="filterCategory('favorites')">المفضلة</span>
                <span class="category-chip" onclick="filterCategory('recent')">الأحدث</span>
                <span class="category-chip" onclick="filterCategory('oldest')">الأقدم</span>
                <span class="category-chip" onclick="filterCategory('largest')">الأكبر حجماً</span>
                <span class="category-chip" onclick="filterCategory('smallest')">الأصغر حجماً</span>
            </div>

            <!-- منطقة رفع الصور المتطورة -->
            <div class="upload-section" id="uploadSection" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <h2 class="upload-title">اسحب وأفلت صورك هنا</h2>
                <p class="upload-hint">أو اضغط لاختيار الصور من جهازك</p>
                <div class="upload-formats">
                    <span class="format-badge">JPG</span>
                    <span class="format-badge">PNG</span>
                    <span class="format-badge">GIF</span>
                    <span class="format-badge">BMP</span>
                    <span class="format-badge">WEBP</span>
                    <span class="format-badge">HEIC</span>
                </div>
                <input type="file" id="fileInput" multiple accept="image/*" style="display: none;" onchange="handleFiles(this.files)">
            </div>

            <!-- زر المسح التلقائي -->
            <div class="text-center mb-4">
                <button class="btn-modern" onclick="startAutoScan()">
                    <i class="fas fa-sync-alt me-2"></i>
                    مسح تلقائي للصور
                </button>
                <button class="btn-modern me-2" onclick="openSettings()">
                    <i class="fas fa-cog me-2"></i>
                    الإعدادات
                </button>
            </div>

            <!-- عرض الصور -->
            <div id="photosGrid" class="grid-container"></div>

            <!-- شاشة فارغة -->
            <div id="emptyState" class="empty-state-modern" style="display: none;">
                <i class="fas fa-images empty-icon"></i>
                <h2 class="empty-title">لا توجد صور بعد</h2>
                <p class="empty-description">قم برفع صورك أو استخدم خاصية المسح التلقائي</p>
                <button class="btn-modern" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-upload me-2"></i>
                    رفع الصور الآن
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة منبثقة متطورة لعرض الصورة -->
    <div class="modal fade modal-modern" id="photoModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="photoModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="photoModalImage" class="preview-image" src="" alt="">
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <p><strong>اسم الملف:</strong> <span id="modalFileName"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>الحجم:</strong> <span id="modalFileSize"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>التاريخ:</strong> <span id="modalFileDate"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>الأبعاد:</strong> <span id="modalDimensions"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">إغلاق</button>
                    <button class="btn btn-primary" onclick="downloadCurrentPhoto()">
                        <i class="fas fa-download"></i> تحميل
                    </button>
                    <button class="btn btn-danger" onclick="deleteCurrentPhoto()">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة الإعدادات -->
    <div class="modal fade modal-modern" id="settingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">الإعدادات</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <label class="form-label">المسح التلقائي</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoScanEnabled" checked>
                            <label class="form-check-label">تفعيل المسح التلقائي عند فتح التطبيق</label>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">جودة الصور</label>
                        <select class="form-control" id="imageQuality">
                            <option value="high">عالية</option>
                            <option value="medium" selected>متوسطة</option>
                            <option value="low">منخفضة</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">حفظ تلقائي</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoSaveEnabled" checked>
                            <label class="form-check-label">حفظ الصور تلقائياً عند الإضافة</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button class="btn btn-primary" onclick="saveSettings()">حفظ الإعدادات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- حاوية الإشعارات -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- تحميل المكتبات -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>
    
    <script>
        // ================ المتغيرات العامة ================
        let photos = [];
        let currentUser = {
            id: 'guest',
            name: 'زائر',
            email: 'guest@example.com'
        };
        let modalInstance = null;
        let settingsModal = null;
        let currentPhotoId = null;
        let filterType = 'all';
        let searchTerm = '';

        // ================ تهيئة التطبيق ================
        document.addEventListener('DOMContentLoaded', async () => {
            // إخفاء شاشة البداية بعد 2 ثانية
            setTimeout(() => {
                document.getElementById('splashScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splashScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    document.getElementById('mainApp').classList.add('animate__animated', 'animate__fadeIn');
                }, 1000);
            }, 2000);

            // تهيئة النوافذ المنبثقة
            modalInstance = new bootstrap.Modal(document.getElementById('photoModal'));
            settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));

            // تحميل الصور المحفوظة
            await loadPhotos();

            // بدء المسح التلقائي إذا كان مفعلاً
            if (localStorage.getItem('autoScanEnabled') !== 'false') {
                setTimeout(() => startAutoScan(), 3000);
            }

            // إعداد السحب والإفلات
            setupDragAndDrop();
        });

        // ================ نظام التخزين المتطور ================
        async function loadPhotos() {
            try {
                const saved = localStorage.getItem('photogallery_photos');
                if (saved) {
                    photos = JSON.parse(saved);
                    // التحقق من صلاحية الصور
                    photos = photos.filter(photo => photo && photo.data && photo.data.startsWith('data:image'));
                } else {
                    photos = [];
                }
                updateDisplay();
            } catch (error) {
                console.error('خطأ في تحميل الصور:', error);
                photos = [];
                updateDisplay();
            }
        }

        async function savePhotos() {
            try {
                localStorage.setItem('photogallery_photos', JSON.stringify(photos));
                showNotification('نجاح', 'تم حفظ الصور بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في حفظ الصور:', error);
                showNotification('خطأ', 'فشل في حفظ الصور', 'error');
            }
        }

        // ================ المسح التلقائي المتطور ================
        async function startAutoScan() {
            showNotification('جاري المسح', 'يتم البحث عن الصور في جهازك...', 'info');
            
            try {
                // محاكاة المسح التلقائي (في التطبيق الحقيقي سيتم الوصول للمجلدات)
                showProgress('جاري المسح... 0%');
                
                // محاكاة العثور على صور
                setTimeout(() => {
                    showProgress('جاري المسح... 25%');
                }, 500);
                
                setTimeout(() => {
                    showProgress('جاري المسح... 50%');
                }, 1000);
                
                setTimeout(() => {
                    showProgress('جاري المسح... 75%');
                }, 1500);
                
                setTimeout(async () => {
                    showProgress('جاري المسح... 100%');
                    
                    // محاكاة إضافة صور من المجلدات
                    const mockPhotos = generateMockPhotos();
                    
                    for (let photo of mockPhotos) {
                        photos.push(photo);
                    }
                    
                    await savePhotos();
                    updateDisplay();
                    
                    showNotification('اكتمل المسح', `تم العثور على ${mockPhotos.length} صورة جديدة`, 'success');
                }, 2000);
                
            } catch (error) {
                console.error('خطأ في المسح التلقائي:', error);
                showNotification('خطأ', 'فشل في المسح التلقائي', 'error');
            }
        }

        // توليد صور تجريبية للمحاكاة
        function generateMockPhotos() {
            const mockPhotos = [];
            const types = ['منظر طبيعي', 'عائلة', 'سفر', 'طعام', 'حيوانات'];
            
            for (let i = 0; i < 5; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                mockPhotos.push({
                    id: `mock_${Date.now()}_${i}`,
                    name: `صورة ${type} ${i + 1}.jpg`,
                    data: `https://picsum.photos/800/600?random=${Math.random()}`,
                    date: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
                    size: Math.floor(Math.random() * 5000000) + 1000000,
                    type: 'image/jpeg',
                    width: 800,
                    height: 600,
                    favorite: Math.random() > 0.7
                });
            }
            
            return mockPhotos;
        }

        function showProgress(text) {
            showNotification('جاري المسح', text, 'info');
        }

        // ================ معالجة رفع الملفات المتطورة ================
        async function handleFiles(files) {
            if (!files || files.length === 0) return;

            showNotification('جاري الرفع', `جاري رفع ${files.length} صورة...`, 'info');

            for (let file of files) {
                if (!file.type.startsWith('image/')) {
                    showNotification('خطأ', `${file.name} ليس صورة`, 'error');
                    continue;
                }

                if (file.size > 50 * 1024 * 1024) {
                    showNotification('خطأ', `${file.name} أكبر من 50MB`, 'error');
                    continue;
                }

                await processFile(file);
            }

            await savePhotos();
            updateDisplay();
            showNotification('نجاح', 'تم رفع جميع الصور بنجاح', 'success');
        }

        function processFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    // الحصول على أبعاد الصورة
                    const dimensions = await getImageDimensions(e.target.result);
                    
                    const photo = {
                        id: `photo_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        name: file.name,
                        data: e.target.result,
                        date: new Date().toISOString(),
                        size: file.size,
                        type: file.type,
                        width: dimensions.width,
                        height: dimensions.height,
                        favorite: false,
                        tags: []
                    };
                    
                    photos.push(photo);
                    resolve();
                };
                
                reader.readAsDataURL(file);
            });
        }

        function getImageDimensions(dataUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    resolve({
                        width: img.width,
                        height: img.height
                    });
                };
                img.src = dataUrl;
            });
        }

        // ================ إعداد السحب والإفلات ================
        function setupDragAndDrop() {
            const uploadSection = document.getElementById('uploadSection');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadSection.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadSection.addEventListener(eventName, () => {
                    uploadSection.classList.add('dragover');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadSection.addEventListener(eventName, () => {
                    uploadSection.classList.remove('dragover');
                });
            });

            uploadSection.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                handleFiles(files);
            });
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // ================ عرض وتحديث الصور ================
        function updateDisplay() {
            const grid = document.getElementById('photosGrid');
            const emptyState = document.getElementById('emptyState');
            const totalPhotos = document.getElementById('totalPhotos');
            const todayPhotos = document.getElementById('todayPhotos');
            const weekPhotos = document.getElementById('weekPhotos');
            const monthPhotos = document.getElementById('monthPhotos');
            const displayStats = document.getElementById('displayStats');

            // تحديث الإحصائيات
            totalPhotos.textContent = photos.length;
            displayStats.textContent = `${photos.length} صورة`;

            const now = new Date();
            const today = photos.filter(p => new Date(p.date).toDateString() === now.toDateString()).length;
            const week = photos.filter(p => {
                const diff = now - new Date(p.date);
                return diff <= 7 * 24 * 60 * 60 * 1000;
            }).length;
            const month = photos.filter(p => {
                const diff = now - new Date(p.date);
                return diff <= 30 * 24 * 60 * 60 * 1000;
            }).length;

            todayPhotos.textContent = today;
            weekPhotos.textContent = week;
            monthPhotos.textContent = month;

            // تطبيق الفلتر والبحث
            let filteredPhotos = filterPhotos(photos);

            if (filteredPhotos.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            // عرض الصور
            grid.innerHTML = filteredPhotos.map(photo => createPhotoCard(photo)).join('');
        }

        function filterPhotos(photosList) {
            let filtered = [...photosList];

            // تطبيق البحث
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            // تطبيق الفلتر
            switch(filterType) {
                case 'favorites':
                    filtered = filtered.filter(p => p.favorite);
                    break;
                case 'recent':
                    filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
                    break;
                case 'oldest':
                    filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
                    break;
                case 'largest':
                    filtered.sort((a, b) => b.size - a.size);
                    break;
                case 'smallest':
                    filtered.sort((a, b) => a.size - b.size);
                    break;
            }

            return filtered;
        }

        function createPhotoCard(photo) {
            const date = new Date(photo.date).toLocaleDateString('ar-SA');
            const size = formatBytes(photo.size);
            
            return `
                <div class="photo-card" onclick="openPhotoModal('${photo.id}')">
                    <img src="${photo.data}" class="photo-img" alt="${photo.name}" loading="lazy">
                    <div class="photo-overlay">
                        <div class="photo-actions">
                            <button class="photo-action-btn ${photo.favorite ? 'favorite' : ''}" onclick="toggleFavorite('${photo.id}', event)">
                                <i class="fas fa-star"></i>
                            </button>
                            <button class="photo-action-btn download" onclick="downloadPhoto('${photo.id}', event)">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="photo-action-btn delete" onclick="deletePhoto('${photo.id}', event)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="photo-info">
                            <div class="photo-name">${photo.name.length > 20 ? photo.name.substring(0,20)+'...' : photo.name}</div>
                            <div class="photo-date">${date} • ${size}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ================ وظائف التفاعل ================
        function searchPhotos() {
            searchTerm = document.getElementById('searchInput').value;
            updateDisplay();
        }

        function filterCategory(type) {
            filterType = type;
            
            // تحديث التصنيف النشط
            document.querySelectorAll('.category-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateDisplay();
        }

        function filterByType(type) {
            filterType = type;
            updateDisplay();
        }

        async function toggleFavorite(id, event) {
            event.stopPropagation();
            const photo = photos.find(p => p.id === id);
            if (photo) {
                photo.favorite = !photo.favorite;
                await savePhotos();
                updateDisplay();
                showNotification('نجاح', photo.favorite ? 'أضيفت إلى المفضلة' : 'أزيلت من المفضلة', 'success');
            }
        }

        async function deletePhoto(id, event) {
            event.stopPropagation();
            
            if (!confirm('هل أنت متأكد من حذف هذه الصورة؟')) return;
            
            photos = photos.filter(p => p.id !== id);
            await savePhotos();
            updateDisplay();
            showNotification('نجاح', 'تم حذف الصورة بنجاح', 'success');
        }

        async function downloadPhoto(id, event) {
            event.stopPropagation();
            const photo = photos.find(p => p.id === id);
            if (photo) {
                const link = document.createElement('a');
                link.href = photo.data;
                link.download = photo.name;
                link.click();
                showNotification('نجاح', 'جاري تحميل الصورة', 'success');
            }
        }

        function openPhotoModal(id) {
            const photo = photos.find(p => p.id === id);
            if (photo) {
                currentPhotoId = id;
                document.getElementById('photoModalTitle').textContent = photo.name;
                document.getElementById('photoModalImage').src = photo.data;
                document.getElementById('modalFileName').textContent = photo.name;
                document.getElementById('modalFileSize').textContent = formatBytes(photo.size);
                document.getElementById('modalFileDate').textContent = new Date(photo.date).toLocaleString('ar-SA');
                document.getElementById('modalDimensions').textContent = `${photo.width} x ${photo.height}`;
                modalInstance.show();
            }
        }

        function downloadCurrentPhoto() {
            if (currentPhotoId) {
                downloadPhoto(currentPhotoId, { stopPropagation: () => {} });
            }
        }

        async function deleteCurrentPhoto() {
            if (currentPhotoId) {
                await deletePhoto(currentPhotoId, { stopPropagation: () => {} });
                modalInstance.hide();
            }
        }

        // ================ الإعدادات ================
        function openSettings() {
            document.getElementById('autoScanEnabled').checked = localStorage.getItem('autoScanEnabled') !== 'false';
            document.getElementById('imageQuality').value = localStorage.getItem('imageQuality') || 'medium';
            document.getElementById('autoSaveEnabled').checked = localStorage.getItem('autoSaveEnabled') !== 'false';
            settingsModal.show();
        }

        function saveSettings() {
            localStorage.setItem('autoScanEnabled', document.getElementById('autoScanEnabled').checked);
            localStorage.setItem('imageQuality', document.getElementById('imageQuality').value);
            localStorage.setItem('autoSaveEnabled', document.getElementById('autoSaveEnabled').checked);
            settingsModal.hide();
            showNotification('نجاح', 'تم حفظ الإعدادات بنجاح', 'success');
        }

        // ================ نظام الإشعارات المتطور ================
        function showNotification(title, message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const id = 'notif_' + Date.now();
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };
            
            const notification = document.createElement('div');
            notification.id = id;
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas ${icons[type]}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.animation = 'slideInLeft 0.3s reverse';
                    setTimeout(() => element.remove(), 300);
                }
            }, 3000);
        }

        // ================ وظائف مساعدة ================
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function toggleUserMenu() {
            // يمكن إضافة قائمة المستخدم هنا
        }
    </script>
</body>
</html>
