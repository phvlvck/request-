<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>معرض الصور - التخزين المحلي</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #2b5876, #4e4376);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container { padding-top: 20px; padding-bottom: 30px; }
        .navbar {
            background: rgba(255,255,255,0.95);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        .upload-area {
            background: rgba(255,255,255,0.9);
            border: 3px dashed #fff;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin: 30px 0;
            cursor: pointer;
            transition: 0.3s;
        }
        .upload-area:hover {
            background: rgba(255,255,255,1);
            transform: scale(1.02);
        }
        .gallery-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            height: 250px;
            position: relative;
        }
        .gallery-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        .card-footer {
            padding: 10px;
            text-align: center;
            background: white;
            border-top: 1px solid #eee;
        }
        .delete-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            color: #dc3545;
            display: none;
            cursor: pointer;
        }
        .gallery-card:hover .delete-btn {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .folder-title {
            color: white;
            font-size: 1.5rem;
            margin: 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid rgba(255,255,255,0.3);
        }
        .stats {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 50px;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-images me-2" style="color: #2b5876;"></i>
                ألبوم الصور المحلي
            </a>
            <div class="d-flex align-items-center">
                <span class="stats me-3" id="photoCount">0 صورة</span>
                <button class="btn btn-outline-danger" onclick="clearAllPhotos()">
                    <i class="fas fa-trash-alt"></i> مسح الكل
                </button>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 80px;">
        <!-- Upload Area -->
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-cloud-upload-alt fa-3x" style="color: #2b5876;"></i>
            <h4 class="mt-3">اضغط هنا لاختيار الصور</h4>
            <p class="text-muted">أو اسحب وأفلت الصور هنا</p>
            <input type="file" id="fileInput" multiple accept="image/*" style="display: none;" onchange="handleFiles(this.files)">
        </div>

        <!-- Folders Container -->
        <div id="foldersContainer"></div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center text-white py-5" style="display: none;">
            <i class="fas fa-images fa-5x mb-4 opacity-50"></i>
            <h3>لا توجد صور بعد</h3>
            <p>قم برفع صورك لتبدأ في إنشاء ألبومك الخاص</p>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" class="img-fluid" src="" alt="">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                    <button class="btn btn-primary" onclick="downloadImage()">
                        <i class="fas fa-download"></i> تحميل
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let photos = [];
        let modalInstance = null;
        let currentImageSrc = '';

        // Initialize - Load photos from IndexedDB
        document.addEventListener('DOMContentLoaded', () => {
            loadFromIndexedDB();
            modalInstance = new bootstrap.Modal(document.getElementById('imageModal'));
        });

        // Handle drag and drop
        document.addEventListener('dragover', (e) => e.preventDefault());
        document.addEventListener('drop', (e) => {
            e.preventDefault();
            if (e.dataTransfer.files) {
                handleFiles(e.dataTransfer.files);
            }
        });

        // Handle file selection
        async function handleFiles(files) {
            for (let file of files) {
                if (!file.type.startsWith('image/')) continue;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const photo = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        data: e.target.result,
                        date: new Date().toISOString(),
                        size: file.size
                    };
                    
                    photos.push(photo);
                    await saveToIndexedDB();
                    displayPhotos();
                };
                reader.readAsDataURL(file);
            }
        }

        // Save to IndexedDB
        async function saveToIndexedDB() {
            const db = await openDB();
            const tx = db.transaction('photos', 'readwrite');
            const store = tx.objectStore('photos');
            
            // Clear and add all photos
            await store.clear();
            for (let photo of photos) {
                await store.add(photo);
            }
            await tx.done;
        }

        // Load from IndexedDB
        async function loadFromIndexedDB() {
            const db = await openDB();
            const tx = db.transaction('photos', 'readonly');
            const store = tx.objectStore('photos');
            photos = await store.getAll();
            displayPhotos();
        }

        // Open IndexedDB connection
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('PhotoGallery', 1);
                
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('photos')) {
                        db.createObjectStore('photos', { keyPath: 'id' });
                    }
                };
                
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        // Display photos
        function displayPhotos() {
            const container = document.getElementById('foldersContainer');
            const emptyState = document.getElementById('emptyState');
            const photoCount = document.getElementById('photoCount');
            
            photoCount.textContent = `${photos.length} صورة`;
            
            if (photos.length === 0) {
                emptyState.style.display = 'block';
                container.innerHTML = '';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Group by date
            const groups = groupByDate(photos);
            container.innerHTML = '';
            
            for (const [date, groupPhotos] of Object.entries(groups)) {
                const section = document.createElement('div');
                section.innerHTML = `
                    <h4 class="folder-title">
                        <i class="fas fa-folder-open me-2"></i>
                        ${date}
                        <span class="stats ms-2">${groupPhotos.length} صورة</span>
                    </h4>
                    <div class="row" id="folder-${date.replace(/\s/g, '-')}"></div>
                `;
                
                container.appendChild(section);
                const row = section.querySelector('.row');
                
                groupPhotos.forEach(photo => {
                    const col = document.createElement('div');
                    col.className = 'col-lg-3 col-md-4 col-sm-6';
                    col.innerHTML = `
                        <div class="gallery-card" onclick="openPhotoModal('${photo.data}', '${photo.name}')">
                            <img src="${photo.data}" alt="${photo.name}">
                            <div class="card-footer">
                                ${photo.name.length > 20 ? photo.name.substring(0,20)+'...' : photo.name}
                            </div>
                            <button class="delete-btn" onclick="deletePhoto('${photo.id}', event)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    row.appendChild(col);
                });
            }
        }

        // Group photos by date
        function groupByDate(photos) {
            const groups = {};
            photos.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            photos.forEach(photo => {
                const date = new Date(photo.date).toLocaleDateString('ar-SA', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                if (!groups[date]) groups[date] = [];
                groups[date].push(photo);
            });
            
            return groups;
        }

        // Delete photo
        async function deletePhoto(id, event) {
            event.stopPropagation();
            if (!confirm('هل أنت متأكد من حذف هذه الصورة؟')) return;
            
            photos = photos.filter(p => p.id != id);
            await saveToIndexedDB();
            displayPhotos();
            showMessage('تم حذف الصورة بنجاح', 'success');
        }

        // Clear all photos
        async function clearAllPhotos() {
            if (!confirm('هل أنت متأكد من حذف جميع الصور؟')) return;
            
            photos = [];
            await saveToIndexedDB();
            displayPhotos();
            showMessage('تم حذف جميع الصور', 'success');
        }

        // Open photo modal
        function openPhotoModal(src, name) {
            document.getElementById('modalTitle').textContent = name;
            document.getElementById('modalImage').src = src;
            currentImageSrc = src;
            modalInstance.show();
        }

        // Download image
        function downloadImage() {
            const link = document.createElement('a');
            link.href = currentImageSrc;
            link.download = 'image.jpg';
            link.click();
        }

        // Show message
        function showMessage(text, type) {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-4`;
            toast.style.zIndex = '9999';
            toast.textContent = text;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }
    </script>
</body>
</html>
